<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #000
        url('https://firebasestorage.googleapis.com/v0/b/pichayut-40dd2.firebasestorage.app/o/pexels-cottonbro-6072439.jpg?alt=media&token=7732ed40-e69f-477e-b342-571957c9c09a')
        no-repeat center center fixed;
      background-size: cover;
      color: #f9fafb;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 1.4rem;
      color: #fefce8;
      text-shadow: 0 2px 4px rgba(0,0,0,0.6);
    }
    .card {
      max-width: 540px;
      margin: 0 auto;
      background: rgba(15,23,42,0.85);
      border-radius: 16px;
      padding: 16px 16px 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
      border: 1px solid rgba(248,250,252,0.15);
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #e5e7eb;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      font-size: 16px; /* ‡∏Å‡∏±‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ã‡∏π‡∏° */
      margin-bottom: 10px;
      background: rgba(15,23,42,0.9);
      color: #f9fafb;
    }
    input[type="text"]::placeholder {
      color: #9ca3af;
    }
    input[readonly] {
      background: rgba(15,23,42,0.8);
    }
    .row-2 {
      display: flex;
      gap: 8px;
    }
    .row-2 > div {
      flex: 1 1 0;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 8px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 16px; /* ‡∏Å‡∏±‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ã‡∏π‡∏° */
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.2s;
      white-space: nowrap;
    }
    button:active {
      transform: scale(0.97);
      box-shadow: 0 3px 8px rgba(0,0,0,0.4);
    }
    .btn-primary {
      background: linear-gradient(135deg, #16a34a, #15803d, #b91c1c);
      color: #fefce8;
      box-shadow: 0 4px 12px rgba(22,163,74,0.6);
    }
    .btn-secondary {
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.7);
    }
    .btn-outline {
      background: transparent;
      border: 1px solid rgba(148,163,184,0.9);
      color: #e5e7eb;
    }
    .btn-full {
      width: 100%;
      margin-top: 6px;
    }
    .msg {
      font-size: 0.85rem;
      margin-top: 2px;
      margin-bottom: 6px;
    }
    .msg.info { color: #bfdbfe; }
    .msg.warn { color: #fbbf24; }
    .msg.error { color: #fecaca; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 0.7rem;
      border-radius: 999px;
      background: rgba(254,240,138,0.15);
      color: #facc15;
      margin-left: 4px;
      vertical-align: middle;
      border: 1px solid rgba(250,204,21,0.4);
    }

    .ticket-wrap {
      max-width: 540px;
      margin: 16px auto 0;
    }
    .ticket {
      position: relative;
      background: radial-gradient(circle at top left, #facc15, #b91c1c 40%, #14532d 100%);
      color: #fff;
      border-radius: 18px;
      padding: 16px 16px 18px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.55);
      overflow: hidden;
      border: 1px solid rgba(250,250,250,0.4);
    }
    .ticket:before,
    .ticket:after {
      content: "";
      position: absolute;
      top: 16px;
      bottom: 16px;
      width: 18px;
      background: #0f172a;
      border-radius: 999px;
    }
    .ticket:before { left: -9px; }
    .ticket:after { right: -9px; }
    .ticket-inner {
      position: relative;
      z-index: 1;
    }
    .ticket-title {
      font-weight: 700;
      font-size: 1.15rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ticket-title span.emoji {
      font-size: 1.2rem;
    }
    .ticket-sub {
      font-size: 0.85rem;
      opacity: 0.95;
      margin-bottom: 10px;
    }
    .ticket-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .ticket-label {
      opacity: 0.9;
    }
    .ticket-value {
      font-weight: 600;
    }
    .ticket-lucky {
      margin-top: 10px;
      text-align: center;
      padding: 10px;
      border-radius: 12px;
      background: rgba(15,23,42,0.35);
      border: 1px dashed rgba(255,255,255,0.85);
      font-size: 1.1rem;
      letter-spacing: 0.15em;
    }
    .ticket-hint {
      margin-top: 6px;
      font-size: 0.8rem;
      opacity: 0.95;
      text-align: center;
    }

    .ticket-tabs {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.8rem;
    }
    .ticket-tab {
      flex: 1 1 0;
      border-radius: 10px;
      padding: 6px 8px;
      background: rgba(15,23,42,0.35);
      border: 1px dashed rgba(248,250,252,0.5);
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
    }
    .ticket-tab.used {
      background: rgba(22,163,74,0.4);
      border-style: solid;
      border-color: rgba(22,163,74,0.9);
    }
    .ticket-tab-title {
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .ticket-tab-status {
      opacity: 0.95;
    }

    .ticket-qr {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .ticket-qr-label {
      font-size: 0.8rem;
      opacity: 0.95;
    }

    .ticket-print-btn {
      margin-top: 8px;
      display: flex;
      justify-content: center;
    }

    .hidden { display: none; }

    .footer-tip {
      max-width: 540px;
      margin: 10px auto 0;
      font-size: 0.8rem;
      color: #e5e7eb;
      text-align: center;
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    }

    .loading {
      font-size: 0.8rem;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 4px;
    }
    .loading-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #9ca3af;
      animation: blink 1s infinite ease-in-out;
    }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; }
      40% { opacity: 1; }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      .card {
        padding: 12px 12px 16px;
      }
      .row-2 {
        flex-direction: column;
      }
    }

    @media print {
      body {
        background: #fff;
        padding: 0;
      }
      .card, .footer-tip {
        display: none !important;
      }
      .ticket-wrap {
        margin-top: 0;
      }
      .ticket {
        box-shadow: none;
      }
      .ticket-print-btn {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <h1>üéÑ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚Äì Christmas Event üéÅ</h1>

  <div class="card">
    <div style="margin-bottom: 10px; font-size: 0.85rem; color:#e5e7eb;">
      ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô<br>
      - ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á<br>
      - ‡∏ñ‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á <strong>‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡∏ù‡πà‡∏≤‡∏¢, ‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°</strong> ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>
      - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>
      - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <strong>GAME / ICE CREAM</strong> ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å‡πÉ‡∏ô Excel (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F, G) ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
    </div>

    <label for="empId">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
    <input type="text" id="empId" list="empIdList" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1000000001" autocomplete="off">
    <datalist id="empIdList"></datalist>

    <div class="btn-row">
      <button type="button" class="btn-secondary" onclick="triggerEmpLookup()">
        üîç ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™
      </button>
      <span id="loadingEmpList" class="loading hidden">
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
      </span>
    </div>
    <div id="msgEmp" class="msg"></div>

    <div class="row-2">
      <div>
        <label for="firstName">‡∏ä‡∏∑‡πà‡∏≠</label>
        <input type="text" id="firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á">
      </div>
      <div>
        <label for="lastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="lastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
    </div>

    <label for="department">‡∏ù‡πà‡∏≤‡∏¢ / ‡πÅ‡∏ú‡∏ô‡∏Å</label>
    <input type="text" id="department" placeholder="‡πÄ‡∏ä‡πà‡∏ô Top Department">

    <label for="luckyNumber">
      ‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°
      <span class="badge">‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™ (0000‚Äì0399)</span>
    </label>
    <input type="text" id="luckyNumber" readonly placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° &quot;‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç&quot;">
    <div class="btn-row">
      <button type="button" class="btn-outline" onclick="requestLucky()">
        üé≤ ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç / ‡∏î‡∏π‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏°
      </button>
      <span id="loadingLucky" class="loading hidden">
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
      </span>
    </div>
    <div id="msgLucky" class="msg"></div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="btn-row">
      <button type="button" class="btn-secondary btn-full" onclick="saveOnly()">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </div>
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô) -->
    <div class="btn-row">
      <button type="button" class="btn-primary btn-full" onclick="showTicket()">
        üéüÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      </button>
    </div>
    <div id="msgSave" class="msg"></div>
  </div>

  <div id="ticketSection" class="ticket-wrap hidden">
    <div class="ticket">
      <div class="ticket-inner">
        <div class="ticket-title">
          <span class="emoji">üéÑ</span>
          <span>Christmas Lucky Ticket</span>
        </div>
        <div class="ticket-sub">Merry Christmas! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>

        <div class="ticket-row">
          <div class="ticket-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
          <div class="ticket-value" id="ticketName">-</div>
        </div>
        <div class="ticket-row">
          <div class="ticket-label">‡∏ù‡πà‡∏≤‡∏¢ / ‡πÅ‡∏ú‡∏ô‡∏Å</div>
          <div class="ticket-value" id="ticketDept">-</div>
        </div>
        <div class="ticket-row">
          <div class="ticket-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
          <div class="ticket-value" id="ticketEmpId">-</div>
        </div>

        <div class="ticket-lucky">
          ‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span id="ticketLucky">----</span>
        </div>

        <!-- ‡πÅ‡∏ó‡πá‡∏ö GAME / ICE CREAM ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Excel -->
        <div class="ticket-tabs">
          <div class="ticket-tab" id="ticketGameTab">
            <div class="ticket-tab-title">GAME</div>
            <div class="ticket-tab-status" id="ticketGameStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
          </div>
          <div class="ticket-tab" id="ticketIceTab">
            <div class="ticket-tab-title">ICE CREAM</div>
            <div class="ticket-tab-status" id="ticketIceStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
          </div>
        </div>

        <!-- QR CODE ‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
        <div class="ticket-qr">
          <div id="ticketQr"></div>
          <div class="ticket-qr-label">‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
        </div>

        <div class="ticket-hint">
          * ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™
        </div>
      </div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡πÉ‡∏ä‡πâ window.print) -->
    <div class="ticket-print-btn">
      <button type="button" class="btn-outline" onclick="printTicket()">
        üñ®Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å / ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
      </button>
    </div>
  </div>

  <div class="footer-tip">
    ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å / ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üéÖ
  </div>

  <!-- QRCode library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // URL Web App ‡∏Ç‡∏≠‡∏á Apps Script
    const API_URL = 'https://script.google.com/macros/s/AKfycbxJtFq2AsruKcOCQQrEqfLBGpYlXOiRGdMRIlisDWPfszT92hv7KediWaX6g7sdgp5c/exec';

    var empMap = {};            // key = empId
    var lastSavedRecord = null; // ‡πÄ‡∏Å‡πá‡∏ö record ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

    async function apiGetEmployees() {
      const res = await fetch(API_URL + '?action=getEmployees', { cache: 'no-store' });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'API error');
      return (json.result && json.result.employees) || [];
    }

    async function apiGetLucky(empId) {
      const url = API_URL + '?action=getLuckyNumber&empId=' + encodeURIComponent(empId);
      const res = await fetch(url, { cache: 'no-store' });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'API error');
      return json.result;
    }

    async function apiSaveEmployee(payload) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'saveEmployee', payload: payload || {} })
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'API error');
      return json.result;
    }

    function setMsg(id, text, type) {
      var el = document.getElementById(id);
      el.textContent = text || '';
      el.className = 'msg ' + (type || '');
    }

    function setLoading(id, isLoading) {
      var el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle('hidden', !isLoading);
    }

    function fillFormFromRecord(record) {
      if (!record) return;

      document.getElementById('empId').value      = record.empId || '';
      document.getElementById('firstName').value  = record.firstName || '';
      document.getElementById('lastName').value   = record.lastName || '';
      document.getElementById('department').value = record.department || '';
      document.getElementById('luckyNumber').value = record.luckyNumber || '';

      if (record.luckyNumber) {
        setMsg('msgLucky', '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'info');
      } else {
        setMsg('msgLucky', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç"', 'warn');
      }

      setMsg('msgEmp', '‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'info');
    }

    function clearFormForNew(empId) {
      document.getElementById('firstName').value  = '';
      document.getElementById('lastName').value   = '';
      document.getElementById('department').value = '';
      document.getElementById('luckyNumber').value = '';
      if (empId) {
        setMsg('msgEmp', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ', 'warn');
      } else {
        setMsg('msgEmp', '', '');
      }
      setMsg('msgLucky', '', '');
      lastSavedRecord = null;
    }

    function handleEmpIdInput() {
      var v = document.getElementById('empId').value.trim();
      if (!v) {
        clearFormForNew('');
        return;
      }
      var rec = empMap[v];
      if (rec) {
        fillFormFromRecord(rec);
        lastSavedRecord = rec;
      } else {
        clearFormForNew(v);
      }
    }

    function triggerEmpLookup() {
      handleEmpIdInput();
    }

    async function initEmpIds() {
      try {
        setLoading('loadingEmpList', true);
        setMsg('msgEmp', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...', 'info');
        const list = await apiGetEmployees();

        empMap = {};
        var dl = document.getElementById('empIdList');
        dl.innerHTML = '';

        (list || []).forEach(function(r) {
          if (!r.empId) return;
          empMap[r.empId] = r;

          var opt = document.createElement('option');
          var label = (r.empId + ' ' + (r.fullName || ((r.firstName || '') + ' ' + (r.lastName || '')))).trim();
          opt.value = r.empId;
          opt.label = label;
          dl.appendChild(opt);
        });

        setMsg('msgEmp', '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', 'info');
      } catch (err) {
        console.error(err);
        setMsg('msgEmp', '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
      } finally {
        setLoading('loadingEmpList', false);
      }
    }

    async function requestLucky() {
      var empId = document.getElementById('empId').value.trim();
      if (!empId) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç');
        return;
      }
      setMsg('msgLucky', '', '');
      setMsg('msgSave', '', '');
      setLoading('loadingLucky', true);

      try {
        const res = await apiGetLucky(empId);
        if (!res) {
          setMsg('msgLucky', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
          return;
        }
        document.getElementById('luckyNumber').value = res.luckyNumber || '';

        if (res.isNew) {
          setMsg('msgLucky', '‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö"', 'info');
        } else {
          setMsg('msgLucky', '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'info');
        }

        if (!empMap[res.empId]) empMap[res.empId] = { empId: res.empId };
        empMap[res.empId].luckyNumber = res.luckyNumber;
      } catch (err) {
        console.error(err);
        setMsg('msgLucky', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
      } finally {
        setLoading('loadingLucky', false);
      }
    }

    // core ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function saveCore() {
      var empId      = document.getElementById('empId').value.trim();
      var firstName  = document.getElementById('firstName').value.trim();
      var lastName   = document.getElementById('lastName').value.trim();
      var department = document.getElementById('department').value.trim();
      var lucky      = document.getElementById('luckyNumber').value.trim();

      if (!empId)      { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return null; }
      if (!firstName)  { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠'); return null; }
      if (!lastName)   { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'); return null; }
      if (!department) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢/‡πÅ‡∏ú‡∏ô‡∏Å'); return null; }
      if (!lucky)      { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); return null; }

      setMsg('msgSave', '', '');
      setLoading('loadingEmpList', true);

      var existedBefore = !!empMap[empId];

      var payload = {
        empId: empId,
        firstName: firstName,
        lastName: lastName,
        department: department,
        luckyNumber: lucky
        // GAME/ICE ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ Excel ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
      };

      try {
        const res = await apiSaveEmployee(payload); // {success, record}
        if (!res || !res.success) {
          setMsg('msgSave', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
          return null;
        }

        var record = res.record || {};
        empMap[record.empId] = record;
        lastSavedRecord = record;

        return { record: record, existedBefore: existedBefore };
      } catch (err) {
        console.error(err);
        setMsg('msgSave', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
        return null;
      } finally {
        setLoading('loadingEmpList', false);
      }
    }

    // ‡∏õ‡∏∏‡πà‡∏°: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    async function saveOnly() {
      const result = await saveCore();
      if (!result) return;

      const existedBefore = result.existedBefore;
      setMsg(
        'msgSave',
        existedBefore
          ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
          : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
        'info'
      );
    }

    function updateTicketTabs(record) {
      var gameTab = document.getElementById('ticketGameTab');
      var iceTab  = document.getElementById('ticketIceTab');
      var gameStatus = document.getElementById('ticketGameStatus');
      var iceStatus  = document.getElementById('ticketIceStatus');

      var hasGame = !!(record && record.game);
      var hasIce  = !!(record && record.ice);

      gameTab.classList.toggle('used', hasGame);
      iceTab.classList.toggle('used', hasIce);

      gameStatus.textContent = hasGame ? '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô / ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
      iceStatus.textContent  = hasIce  ? '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô / ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
    }

    function renderTicketQr(empId) {
      var container = document.getElementById('ticketQr');
      container.innerHTML = '';
      if (!empId) return;
      new QRCode(container, {
        text: String(empId),
        width: 96,
        height: 96
      });
    }

    function renderTicketFromRecord(record) {
      if (!record) return;

      var showName = record.fullName ||
        ((record.firstName || '') + ' ' + (record.lastName || '')).trim();
      var showDept  = record.department || '-';
      var showEmp   = record.empId || '-';
      var showLucky = record.luckyNumber || '----';

      document.getElementById('ticketName').textContent  = showName || '-';
      document.getElementById('ticketDept').textContent  = showDept || '-';
      document.getElementById('ticketEmpId').textContent = showEmp || '-';
      document.getElementById('ticketLucky').textContent = showLucky || '----';

      updateTicketTabs(record);
      renderTicketQr(showEmp);

      document.getElementById('ticketSection').classList.remove('hidden');
      window.scrollTo({
        top: document.getElementById('ticketSection').offsetTop - 10,
        behavior: 'smooth'
      });
    }

    async function showTicket() {
      if (!lastSavedRecord) {
        const confirmSave = confirm('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
        if (!confirmSave) return;
        const result = await saveCore();
        if (!result) return;
      }
      renderTicketFromRecord(lastSavedRecord);
      setMsg('msgSave', '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'info');
    }

    function printTicket() {
      const section = document.getElementById('ticketSection');
      if (section.classList.contains('hidden')) {
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" ‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }
      window.print();
    }

    document.getElementById('empId').addEventListener('input', handleEmpIdInput);
    document.getElementById('empId').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        triggerEmpLookup();
      }
    });

    initEmpIds();
  </script>
</body>
</html>
